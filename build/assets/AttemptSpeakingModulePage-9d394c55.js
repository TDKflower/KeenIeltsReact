import{r as s,K as de,j as e,M as oe,N as ue,g as Z,a as W,b,B as me,S as he,c as $,h as fe,f as pe,u as xe,A as ge,C as R,H as je}from"./index-e388c6e0.js";import{M as ye}from"./MiniNavBar-a6caf98b.js";import{B as we}from"./BookInfo-a10e1214.js";import{M as te,a as be,b as Ne}from"./index.esm-2f65f2b8.js";import{S as ve}from"./SpeakingLoader-85a97578.js";import{M as B}from"./Modal-33d57697.js";import"./ButtonGroup-c1646b01.js";import"./Table-7d0efeb1.js";import"./EvaluationLoader-2a21333c.js";const ne=1e3;function ke(m,h,f){const o=(m-h)/(f-h)*100;return Math.round(o*ne)/ne}function ae({min:m,now:h,max:f,label:o,visuallyHidden:x,striped:i,animated:j,className:N,style:d,variant:v,bsPrefix:y,...C},g){return e.jsx("div",{ref:g,...C,role:"progressbar",className:oe(N,`${y}-bar`,{[`bg-${v}`]:v,[`${y}-bar-animated`]:j,[`${y}-bar-striped`]:j||i}),style:{width:`${ke(h,m,f)}%`,...d},"aria-valuenow":h,"aria-valuemin":m,"aria-valuemax":f,children:x?e.jsx("span",{className:"visually-hidden",children:o}):o})}const ie=s.forwardRef(({isChild:m=!1,...h},f)=>{const o={min:0,max:100,animated:!1,visuallyHidden:!1,striped:!1,...h};if(o.bsPrefix=de(o.bsPrefix,"progress"),m)return ae(o,f);const{min:x,now:i,max:j,label:N,visuallyHidden:d,striped:v,animated:y,bsPrefix:C,variant:g,className:U,children:w,...E}=o;return e.jsx("div",{ref:f,...E,className:oe(U,C),children:w?ue(w,M=>s.cloneElement(M,{isChild:!0})):ae({min:x,now:i,max:j,label:N,visuallyHidden:d,striped:v,animated:y,bsPrefix:C,variant:g},f)})});ie.displayName="ProgressBar";const Se=ie;const Te=({isSpeaking:m,background:h="primary"})=>e.jsx("div",{className:`d-flex justify-content-center align-items-center bg-${h}`,style:{height:"30px"},children:m?e.jsxs("div",{className:"d-flex justify-content-between align-items-center",children:[e.jsx("div",{className:"waveform-bar animated rounded"}),e.jsx("div",{className:"waveform-bar animated rounded"}),e.jsx("div",{className:"waveform-bar animated rounded"})]}):e.jsxs("div",{className:"d-flex justify-content-between align-items-center",children:[e.jsx("div",{className:"waveform-dot"}),e.jsx("div",{className:"waveform-dot"}),e.jsx("div",{className:"waveform-dot"})]})}),Re=({deviceType:m,isSpeaking:h,setIsSpeaking:f,currentQuestion:o,setCurrentQuestion:x,currentSection:i,setCurrentSection:j,setIsEndTest:N,module:d,userAllResponse:v,setUserAllResponse:y,handleConfirmEndTest:C,testStarted:g,setIsTestStarted:U,setMicAccessError:w})=>{const[E,M]=s.useState(""),[p,P]=s.useState(null),[q,F]=s.useState(!1),[H,D]=s.useState(0),[z,I]=s.useState(!1),[L,_]=s.useState(null),[K,J]=s.useState(0),[O,Y]=s.useState(0),[G,Q]=s.useState(i),[A,k]=s.useState(5);s.useEffect(()=>{switch(console.log("audioCurrent Section",i.section),i.section){case"Part 1":k(5);break;case"Part 2":k(60);break;case"Part 3":k(10);break;default:k(5)}},[o]),s.useEffect(()=>{let t;return g&&A>0?(c(),t=setInterval(()=>{k(n=>n-1)},1e3)):A===0&&u(),()=>clearInterval(t)},[A,o]),s.useEffect(()=>{let t=0;d.sections.forEach(n=>{t+=n.questions.length}),Y(t)},[d]),s.useEffect(()=>{let t=0;for(let n=0;n<d.sections.length;n++){const a=d.sections[n];if(a===i){t+=i.questions.indexOf(o)+1;break}else t+=a.questions.length}J(t/O*100)},[o,i,d,O]),s.useEffect(()=>{g&&E&&(S(G.id,E),Q(i))},[E]),s.useEffect(()=>{let t;return z?(t=setInterval(()=>{D(n=>n+1)},1e3),_(t)):!z&&L&&clearInterval(L),()=>{t&&clearInterval(t)}},[z]),s.useEffect(()=>{D(0)},[o]),s.useEffect(()=>{if(p){const t=new AudioContext,n=t.createAnalyser(),a=new Uint8Array(n.frequencyBinCount);navigator.mediaDevices.getUserMedia({audio:!0}).then(X=>{t.createMediaStreamSource(X).connect(n);const se=()=>{n.getByteFrequencyData(a),a.reduce((re,ce)=>re+ce)/a.length>15?f(!0):f(!1),requestAnimationFrame(se)};se()})}},[p]);const V=()=>{w(null),l()},l=()=>{console.log("Running startRecording"),navigator.mediaDevices.getUserMedia({audio:!0}).then(t=>{U(!0);const n=new MediaRecorder(t);P(n),n.ondataavailable=a=>{if(a.data.size>0){const X=new Blob([a.data],{type:"audio/wav"}),ee=URL.createObjectURL(X);M(ee)}},n.start(),I(!0)}).catch(t=>{console.error("Could not get media:",t),w("Unable to access microphone. Please allow microphone access to start the test.")})},c=()=>{p&&p.state==="recording"&&(p.pause(),I(!1),F(!0))},u=()=>{p&&p.state==="paused"&&(p.resume(),I(!0),F(!1))},r=()=>{console.log("Running stopRecording"),p&&(p.stop(),p.stream.getTracks().forEach(t=>t.stop()),P(null))};function S(t=null,n=null){if(i&&o&&i.id&&o.id){const a=v?JSON.parse(JSON.stringify(v)):{};return a[i.id]||(a[i.id]={}),a[i.id][o.id]||(a[i.id][o.id]={}),a[i.id][o.id].elapsedTime=H,n&&(a.fullAudio=n),y(a),a}else console.error("Either currentSection, currentQuestion or their IDs are null or not set.")}function T(){console.log("Running handleNextQuestion"),S();const t=i.questions.findIndex(n=>n===o);if(t!==-1&&t<i.questions.length-1){const n=i.questions[t+1];x(n)}else if(t===i.questions.length-1){const n=d.sections.findIndex(a=>a===i);if(n!==-1&&n<d.sections.length-1){const a=d.sections[n+1];j(a),x(a.questions[0])}else n===d.sections.length-1&&(N(!0),r())}else console.log("Question not found or already at the end.")}function le(t){const n=Math.floor(t/60),a=t%60;return`${n}:${a<10?"0":""}${a}`}return e.jsxs("div",{className:" border-top bg-white",style:{position:"fixed",bottom:0,width:"100%"},children:[e.jsx(Se,{now:K,className:"mb-2 rounded-0",style:{height:"5px"}}),e.jsx(Z,{className:"",children:e.jsx(W,{className:"mt-2 text-black justify-content-center ",children:e.jsx(b,{sm:8,className:"",children:e.jsx("div",{className:"mt-2  text-center",children:q?A>0?e.jsxs("p",{className:"text-dark fw-bold m-0",style:{fontSize:"1.4rem"},children:[A," secs"]}):e.jsx("div",{className:"text-danger",children:"On pause"}):e.jsx("div",{children:e.jsx(me,{bg:"dark",className:"",style:{fontSize:"20px",width:"125px"},children:e.jsxs(he,{direction:"horizontal",className:"",children:[e.jsx("div",{className:"mx-2",children:e.jsx(Te,{isSpeaking:h,background:"dark"})}),e.jsx("div",{className:"mx-2",children:le(H)})]})})})})})})}),e.jsx("hr",{}),e.jsx(Z,{children:e.jsx(W,{className:"my-2 mb-3 text-black justify-content-center ",children:e.jsx(b,{sm:8,children:e.jsxs(W,{className:"",children:[g?q?A>0?e.jsx(b,{className:"col-12 mt-1 text-center",children:e.jsx("p",{className:"text-dark  m-0",style:{fontSize:"1.4rem"},children:"Time to think"})}):e.jsx(b,{className:"col-12 mt-1",children:e.jsxs($,{onClick:u,className:`w-100 ${m==="desktop"&&"btn-lg"}`,children:[e.jsx(te,{size:23})," Continue"]})}):e.jsx(b,{className:`col-${g?6:12} mt-1`,children:e.jsxs($,{variant:"",onClick:c,className:`w-100 ${m==="desktop"&&"btn-lg"} btn-outline-primary`,children:[e.jsx(be,{size:23})," Pause"]})}):e.jsx(b,{className:`col-${g?6:12} mt-1`,children:e.jsxs($,{onClick:V,className:`w-100 ${m==="desktop"&&"btn-lg"}`,children:[e.jsx(te,{size:23})," Start Test"]})}),e.jsx(b,{className:"col-6 mt-1",children:g&&!q&&e.jsxs($,{onClick:T,className:`w-100 ${m==="desktop"&&"btn-lg"}`,disabled:!g&&"disabled",children:["Next ",e.jsx(Ne,{size:23})]})})]})})})})]})},ze=()=>{const[m,h]=s.useState("desktop"),{module_slug:f,attempt_slug:o}=fe(),[x,i]=s.useState(null),[j,N]=s.useState(null),d=pe(),[v,y]=s.useState(!1),C=()=>y(!1),[g,U]=s.useState(!1),[w,E]=s.useState(null),[M,p]=s.useState(null),[P,q]=s.useState(null),[F,H]=s.useState(!1),[D,z]=s.useState(!1),I=()=>z(!1);xe();const[L,_]=s.useState(!1),[K,J]=s.useState(null);s.useEffect(()=>{O()},[]),s.useEffect(()=>{x&&(console.log("isEndTest",P),P?w.fullAudio&&k(w):console.log("Full Audio Not Available"))},[P,w]),s.useEffect(()=>{const l=()=>{window.innerWidth<768?h("mobile"):h("desktop")};return l(),window.addEventListener("resize",l),()=>{window.removeEventListener("resize",l)}},[]);async function O(){const l=await d.post(ge.getSpeakingModule+f+"/");if(l.status===200){i(l.data);const c=l.data.sections[0];N(c),p(c.questions[0])}}function Y(l){const c=x.sections.find(u=>u.id===l);N(c)}async function G(l="In Progress",c){let u=new FormData;u.append("attempt_type",l);for(const r in c)if(r==="fullAudio"){console.log("Merged Audio",c[r]);const S=c[r],T=new Blob([S],{type:"audio/wav"});u.append(`${r}`,T)}else{const S=c[r];for(const T in S)T!=="audio"&&u.append(`${r},${T}`,JSON.stringify(S[T]))}try{const r=await d.post(`/ieltstest/update_attempt/speaking/${o}/`,u);return r.status===200?(console.log("Attempt updated successfully"),!0):(console.log("Failed to update attempt",r),!1)}catch(r){return console.error("There was an error sending the request",r),!1}}async function Q(l){return new Promise((c,u)=>{const r=new FileReader;r.onloadend=()=>{c(r.result)},r.onerror=u,r.readAsArrayBuffer(l)})}async function A(l){console.log("Inside replace audio");for(const c in l)if(c==="fullAudio"){const u=l[c],r=await fetch(u).then(T=>T.blob()),S=await Q(r);l={...l,fullAudio:S}}return l}async function k(l){console.log("Handle Confirm End Test"),H(!0);const c=await A(l),u=await G("Completed",c);console.log("isUpdateSuccessful",u),u?window.location.href=`/ieltstest/attempt/speaking/${f}/${o}/completed`:console.error("Failed to update the attempt"),I()}const V={paddingTop:"50px",paddingBottom:"50px",height:"calc(100vh - 50px)",overflow:"auto"};return s.useEffect(()=>{document.title="Speaking Test | KeenIELTS"},[]),x?F?e.jsx(ve,{}):e.jsxs(e.Fragment,{children:[e.jsx("script",{src:"https://unpkg.com/audiobuffer-to-wav"}),e.jsx(ye,{module:x,currentSection:j,updateCurrentSection:Y,setShowTestInfoModal:y,showSectionList:!1}),e.jsx(Z,{style:V,className:"hide-scrollbar",children:e.jsx(W,{style:{height:"80%"},className:"d-flex align-items-center justify-content-center",children:L?e.jsx(b,{sm:8,children:e.jsx("div",{style:{width:"100%"},children:e.jsxs(R,{className:"my-3",children:[e.jsx(R.Header,{children:e.jsxs("span",{className:"text-black fw-bold",children:[j.section," :"," ",j.question_type.name]})}),e.jsxs(R.Body,{children:[e.jsx("p",{className:"fw-bold",style:{fontSize:"1.4rem"},children:M.question}),M.help_text&&e.jsx("p",{children:je(M.help_text)})]})]})})}):K?e.jsx(b,{sm:8,children:e.jsx("div",{style:{width:"100%"},children:e.jsxs(R,{className:"my-3",children:[e.jsx(R.Header,{children:e.jsx("span",{className:"text-black fw-bold",children:"Microphone Access Needed"})}),e.jsxs(R.Body,{children:[e.jsx("p",{className:"fw-bold",style:{fontSize:"16px"},children:"We noticed an issue accessing your microphone. For the speaking test, please ensure microphone access is granted."}),e.jsx("p",{className:"",style:{fontSize:"16px"},children:e.jsxs("ul",{children:[e.jsx("li",{children:"Check your browser's permissions and confirm that your microphone is not in use by another application."}),e.jsx("li",{children:"Click on the 'Start Test' button again. When prompted, select to allow microphone access."}),e.jsx("li",{children:"If the issue persists, consider restarting your browser or switching to a different one."}),e.jsx("li",{children:"Your progress and success in the speaking test matter to us. We're here to help every step of the way!"})]})})]})]})})}):e.jsx(b,{sm:8,children:e.jsx("div",{style:{width:"100%"},children:e.jsxs(R,{className:"my-3",children:[e.jsx(R.Header,{children:e.jsx("h3",{className:"text-black fw-bold mt-2",children:"Ready to Begin Your Speaking Test?"})}),e.jsx(R.Body,{children:e.jsx("p",{className:"",style:{fontSize:"16px"},children:e.jsxs("ul",{children:[e.jsx("li",{children:"Get set for a quick and engaging speaking test, lasting just 15-20 minutes."}),e.jsx("li",{children:`We're excited to hear you! But first, we'll need your permission to access your microphone. Don't worry, a prompt will appear when you hit "Start Test."`}),e.jsx("li",{children:`Feeling prepared? Great! Simply click "Start Test" when you're all set to go.`})]})})})]})})})})}),e.jsx(Re,{deviceType:m,isSpeaking:g,setIsSpeaking:U,currentQuestion:M,setCurrentQuestion:p,currentSection:j,setCurrentSection:N,setIsEndTest:q,module:x,userAllResponse:w,setUserAllResponse:E,handleConfirmEndTest:k,testStarted:L,setIsTestStarted:_,setMicAccessError:J}),e.jsxs(B,{show:v,onHide:C,centered:!0,className:"p-0",children:[e.jsx(B.Header,{closeButton:!0,children:e.jsx(B.Title,{children:"Test Info"})}),e.jsx(B.Body,{className:"p-0",children:e.jsx(we,{module:x,attempt_slug:o})}),e.jsx("div",{className:"modal-footer py-2",children:e.jsx("button",{type:"button",className:"btn btn-outline-primary",onClick:C,children:"Close"})})]}),e.jsxs(B,{show:D,onHide:I,centered:!0,children:[e.jsx(B.Header,{closeButton:!0,children:e.jsx(B.Title,{children:"End Test"})}),e.jsx(B.Body,{children:"Are you sure you want to end the test?"}),e.jsxs(B.Footer,{className:"p-2",children:[e.jsx($,{variant:"outline-primary",onClick:I,children:"No"}),e.jsx($,{variant:"primary",onClick:k,children:"Yes, end test"})]})]})]}):null};export{ze as default};
//# sourceMappingURL=AttemptSpeakingModulePage-9d394c55.js.map
