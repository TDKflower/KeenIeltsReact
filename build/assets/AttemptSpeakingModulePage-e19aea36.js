import{r as s,N as me,j as e,P as ie,Q as he,h as Z,a as _,b,B as fe,S as pe,c as $,i as xe,g as ge,u as je,A as ye,C as R,H as we}from"./index-8f03038e.js";import{M as be}from"./MiniNavBar-5b04eaba.js";import{B as Ne}from"./BookInfo-125ea882.js";import{M as ne,a as ve,b as ke}from"./index.esm-a8d9f939.js";import{S as Se}from"./SpeakingLoader-86d0a4f3.js";import{M as B}from"./Modal-b8c5507a.js";import"./ButtonGroup-e14cb7ff.js";import"./Table-1676ddff.js";import"./EvaluationLoader-587908f9.js";const ae=1e3;function Te(u,h,f){const i=(u-h)/(f-h)*100;return Math.round(i*ae)/ae}function oe({min:u,now:h,max:f,label:i,visuallyHidden:x,striped:l,animated:j,className:N,style:d,variant:v,bsPrefix:y,...C},g){return e.jsx("div",{ref:g,...C,role:"progressbar",className:ie(N,`${y}-bar`,{[`bg-${v}`]:v,[`${y}-bar-animated`]:j,[`${y}-bar-striped`]:j||l}),style:{width:`${Te(h,u,f)}%`,...d},"aria-valuenow":h,"aria-valuemin":u,"aria-valuemax":f,children:x?e.jsx("span",{className:"visually-hidden",children:i}):i})}const le=s.forwardRef(({isChild:u=!1,...h},f)=>{const i={min:0,max:100,animated:!1,visuallyHidden:!1,striped:!1,...h};if(i.bsPrefix=me(i.bsPrefix,"progress"),u)return oe(i,f);const{min:x,now:l,max:j,label:N,visuallyHidden:d,striped:v,animated:y,bsPrefix:C,variant:g,className:q,children:w,...E}=i;return e.jsx("div",{ref:f,...E,className:ie(q,C),children:w?he(w,I=>s.cloneElement(I,{isChild:!0})):oe({min:x,now:l,max:j,label:N,visuallyHidden:d,striped:v,animated:y,bsPrefix:C,variant:g},f)})});le.displayName="ProgressBar";const Re=le;const Be=({isSpeaking:u,background:h="primary"})=>e.jsx("div",{className:`d-flex justify-content-center align-items-center bg-${h}`,style:{height:"30px"},children:u?e.jsxs("div",{className:"d-flex justify-content-between align-items-center",children:[e.jsx("div",{className:"waveform-bar animated rounded"}),e.jsx("div",{className:"waveform-bar animated rounded"}),e.jsx("div",{className:"waveform-bar animated rounded"})]}):e.jsxs("div",{className:"d-flex justify-content-between align-items-center",children:[e.jsx("div",{className:"waveform-dot"}),e.jsx("div",{className:"waveform-dot"}),e.jsx("div",{className:"waveform-dot"})]})}),Ce=({deviceType:u,isSpeaking:h,setIsSpeaking:f,currentQuestion:i,setCurrentQuestion:x,currentSection:l,setCurrentSection:j,setIsEndTest:N,module:d,userAllResponse:v,setUserAllResponse:y,handleConfirmEndTest:C,testStarted:g,setIsTestStarted:q,setMicAccessError:w})=>{const[E,I]=s.useState(""),[p,P]=s.useState(null),[U,L]=s.useState(!1),[H,D]=s.useState(0),[z,M]=s.useState(!1),[F,J]=s.useState(null),[K,Y]=s.useState(0),[O,G]=s.useState(0),[Q,V]=s.useState(l),[A,k]=s.useState(5),[W,a]=s.useState(null);s.useEffect(()=>{switch(console.log("audioCurrent Section",l.section),l.section){case"Part 1":k(0),a(null);break;case"Part 2":k(0),a("Speak for approximately 2 minutes.");break;case"Part 3":k(0),a(null);break;default:k(0),a(null)}},[i]),s.useEffect(()=>{let t;return g&&A>0?(r(),t=setInterval(()=>{k(n=>n-1)},1e3)):A===0&&S(),()=>clearInterval(t)},[A,i]),s.useEffect(()=>{let t=0;d.sections.forEach(n=>{t+=n.questions.length}),G(t)},[d]),s.useEffect(()=>{let t=0;for(let n=0;n<d.sections.length;n++){const o=d.sections[n];if(o===l){t+=l.questions.indexOf(i)+1;break}else t+=o.questions.length}Y(t/O*100)},[i,l,d,O]),s.useEffect(()=>{g&&E&&(ee(Q.id,E),V(l))},[E]),s.useEffect(()=>{let t;return z?(t=setInterval(()=>{D(n=>n+1)},1e3),J(t)):!z&&F&&clearInterval(F),()=>{t&&clearInterval(t)}},[z]),s.useEffect(()=>{D(0)},[i]),s.useEffect(()=>{if(p){const t=new AudioContext,n=t.createAnalyser(),o=new Uint8Array(n.frequencyBinCount);navigator.mediaDevices.getUserMedia({audio:!0}).then(X=>{t.createMediaStreamSource(X).connect(n);const te=()=>{n.getByteFrequencyData(o),o.reduce((de,ue)=>de+ue)/o.length>15?f(!0):f(!1),requestAnimationFrame(te)};te()})}},[p]);const c=()=>{w(null),m()},m=()=>{console.log("Running startRecording"),navigator.mediaDevices.getUserMedia({audio:!0}).then(t=>{q(!0);const n=new MediaRecorder(t);P(n),n.ondataavailable=o=>{if(o.data.size>0){const X=new Blob([o.data],{type:"audio/wav"}),se=URL.createObjectURL(X);I(se)}},n.start(),M(!0)}).catch(t=>{console.error("Could not get media:",t),w("Unable to access microphone. Please allow microphone access to start the test.")})},r=()=>{p&&p.state==="recording"&&(p.pause(),M(!1),L(!0))},S=()=>{p&&p.state==="paused"&&(p.resume(),M(!0),L(!1))},T=()=>{console.log("Running stopRecording"),p&&(p.stop(),p.stream.getTracks().forEach(t=>t.stop()),P(null))};function ee(t=null,n=null){if(l&&i&&l.id&&i.id){const o=v?JSON.parse(JSON.stringify(v)):{};return o[l.id]||(o[l.id]={}),o[l.id][i.id]||(o[l.id][i.id]={}),o[l.id][i.id].elapsedTime=H,n&&(o.fullAudio=n),y(o),o}else console.error("Either currentSection, currentQuestion or their IDs are null or not set.")}function re(){console.log("Running handleNextQuestion"),ee();const t=l.questions.findIndex(n=>n===i);if(t!==-1&&t<l.questions.length-1){const n=l.questions[t+1];x(n)}else if(t===l.questions.length-1){const n=d.sections.findIndex(o=>o===l);if(n!==-1&&n<d.sections.length-1){const o=d.sections[n+1];j(o),x(o.questions[0])}else n===d.sections.length-1&&(N(!0),T())}else console.log("Question not found or already at the end.")}function ce(t){const n=Math.floor(t/60),o=t%60;return`${n}:${o<10?"0":""}${o}`}return e.jsxs("div",{className:" border-top bg-white",style:{position:"fixed",bottom:0,width:"100%"},children:[e.jsx(Re,{now:K,className:"mb-2 rounded-0",style:{height:"5px"}}),e.jsx(Z,{className:"",children:e.jsx(_,{className:"mt-2 text-black justify-content-center ",children:e.jsx(b,{sm:8,className:"",children:e.jsx("div",{className:"mt-2  text-center",children:U?A>0?e.jsxs("p",{className:"text-dark fw-bold m-0",style:{fontSize:"1.4rem"},children:[A," secs"]}):e.jsx("div",{className:"text-danger",children:"On pause"}):e.jsxs(e.Fragment,{children:[e.jsx("div",{children:e.jsx(fe,{bg:"dark",className:"",style:{fontSize:"20px",width:"125px"},children:e.jsxs(pe,{direction:"horizontal",className:"",children:[e.jsx("div",{className:"mx-2",children:e.jsx(Be,{isSpeaking:h,background:"dark"})}),e.jsx("div",{className:"mx-2",children:ce(H)})]})})}),W&&e.jsxs(e.Fragment,{children:[e.jsx("hr",{}),e.jsx("p",{className:"m-0 p-0",children:W})]})]})})})})}),e.jsx("hr",{}),e.jsx(Z,{children:e.jsx(_,{className:"my-2 mb-3 text-black justify-content-center ",children:e.jsx(b,{sm:8,children:e.jsxs(_,{className:"",children:[g?U?A>0?e.jsx(b,{className:"col-12 mt-1 text-center",children:e.jsx("p",{className:"text-dark  m-0",style:{fontSize:"1.4rem"},children:"Time to think"})}):e.jsx(b,{className:"col-12 mt-1",children:e.jsxs($,{onClick:S,className:`w-100 ${u==="desktop"&&"btn-lg"}`,children:[e.jsx(ne,{size:23})," Continue"]})}):e.jsx(b,{className:`col-${g?6:12} mt-1`,children:e.jsxs($,{variant:"",onClick:r,className:`w-100 ${u==="desktop"&&"btn-lg"} btn-outline-primary`,children:[e.jsx(ve,{size:23})," Pause"]})}):e.jsx(b,{className:`col-${g?6:12} mt-1`,children:e.jsxs($,{onClick:c,className:`w-100 ${u==="desktop"&&"btn-lg"}`,children:[e.jsx(ne,{size:23})," Start Test"]})}),e.jsx(b,{className:"col-6 mt-1",children:g&&!U&&e.jsxs($,{onClick:re,className:`w-100 ${u==="desktop"&&"btn-lg"}`,disabled:!g&&"disabled",children:["Next ",e.jsx(ke,{size:23})]})})]})})})})]})},Le=()=>{const[u,h]=s.useState("desktop"),{module_slug:f,attempt_slug:i}=xe(),[x,l]=s.useState(null),[j,N]=s.useState(null),d=ge(),[v,y]=s.useState(!1),C=()=>y(!1),[g,q]=s.useState(!1),[w,E]=s.useState(null),[I,p]=s.useState(null),[P,U]=s.useState(null),[L,H]=s.useState(!1),[D,z]=s.useState(!1),M=()=>z(!1);je();const[F,J]=s.useState(!1),[K,Y]=s.useState(null);s.useEffect(()=>{O()},[]),s.useEffect(()=>{x&&(console.log("isEndTest",P),P?w.fullAudio&&k(w):console.log("Full Audio Not Available"))},[P,w]),s.useEffect(()=>{const a=()=>{window.innerWidth<768?h("mobile"):h("desktop")};return a(),window.addEventListener("resize",a),()=>{window.removeEventListener("resize",a)}},[]);async function O(){const a=await d.post(ye.getSpeakingModule+f+"/");if(a.status===200){l(a.data);const c=a.data.sections[0];N(c),p(c.questions[0])}}function G(a){const c=x.sections.find(m=>m.id===a);N(c)}async function Q(a="In Progress",c){let m=new FormData;m.append("attempt_type",a);for(const r in c)if(r==="fullAudio"){console.log("Merged Audio",c[r]);const S=c[r],T=new Blob([S],{type:"audio/wav"});m.append(`${r}`,T)}else{const S=c[r];for(const T in S)T!=="audio"&&m.append(`${r},${T}`,JSON.stringify(S[T]))}try{const r=await d.post(`/ieltstest/update_attempt/speaking/${i}/`,m);return r.status===200?(console.log("Attempt updated successfully"),!0):(console.log("Failed to update attempt",r),!1)}catch(r){return console.error("There was an error sending the request",r),!1}}async function V(a){return new Promise((c,m)=>{const r=new FileReader;r.onloadend=()=>{c(r.result)},r.onerror=m,r.readAsArrayBuffer(a)})}async function A(a){console.log("Inside replace audio");for(const c in a)if(c==="fullAudio"){const m=a[c],r=await fetch(m).then(T=>T.blob()),S=await V(r);a={...a,fullAudio:S}}return a}async function k(a){console.log("Handle Confirm End Test"),H(!0);const c=await A(a),m=await Q("Completed",c);console.log("isUpdateSuccessful",m),m?window.location.href=`/ieltstest/attempt/speaking/${f}/${i}/completed`:console.error("Failed to update the attempt"),M()}const W={paddingTop:"50px",paddingBottom:"50px",height:"calc(100vh - 50px)",overflow:"auto"};return s.useEffect(()=>{document.title="Speaking Test | KeenIELTS"},[]),x?L?e.jsx(Se,{}):e.jsxs(e.Fragment,{children:[e.jsx("script",{src:"https://unpkg.com/audiobuffer-to-wav"}),e.jsx(be,{module:x,currentSection:j,updateCurrentSection:G,setShowTestInfoModal:y,showSectionList:!1}),e.jsx(Z,{style:W,className:"hide-scrollbar",children:e.jsx(_,{style:{height:"80%"},className:"d-flex align-items-center justify-content-center",children:F?e.jsx(b,{sm:8,children:e.jsx("div",{style:{width:"100%"},children:e.jsxs(R,{className:"my-3",children:[e.jsx(R.Header,{children:e.jsxs("span",{className:"text-black fw-bold",children:[j.section," :"," ",j.question_type.name]})}),e.jsxs(R.Body,{children:[e.jsx("p",{className:"fw-bold",style:{fontSize:"1.4rem"},children:I.question}),I.help_text&&e.jsx("p",{children:we(I.help_text)})]})]})})}):K?e.jsx(b,{sm:8,children:e.jsx("div",{style:{width:"100%"},children:e.jsxs(R,{className:"my-3",children:[e.jsx(R.Header,{children:e.jsx("span",{className:"text-black fw-bold",children:"Microphone Access Needed"})}),e.jsxs(R.Body,{children:[e.jsx("p",{className:"fw-bold",style:{fontSize:"16px"},children:"We noticed an issue accessing your microphone. For the speaking test, please ensure microphone access is granted."}),e.jsx("p",{className:"",style:{fontSize:"16px"},children:e.jsxs("ul",{children:[e.jsx("li",{children:"Check your browser's permissions and confirm that your microphone is not in use by another application."}),e.jsx("li",{children:"Click on the 'Start Test' button again. When prompted, select to allow microphone access."}),e.jsx("li",{children:"If the issue persists, consider restarting your browser or switching to a different one."}),e.jsx("li",{children:"Your progress and success in the speaking test matter to us. We're here to help every step of the way!"})]})})]})]})})}):e.jsx(b,{sm:8,children:e.jsx("div",{style:{width:"100%"},children:e.jsxs(R,{className:"my-3",children:[e.jsx(R.Header,{children:e.jsx("h3",{className:"text-black fw-bold mt-2",children:"Ready to Begin Your Speaking Test?"})}),e.jsx(R.Body,{children:e.jsx("p",{className:"",style:{fontSize:"16px"},children:e.jsxs("ul",{children:[e.jsx("li",{children:"Get set for a quick and engaging speaking test, lasting just 15-20 minutes."}),e.jsx("li",{children:`We're excited to hear you! But first, we'll need your permission to access your microphone. Don't worry, a prompt will appear when you hit "Start Test."`}),e.jsx("li",{children:`Feeling prepared? Great! Simply click "Start Test" when you're all set to go.`})]})})})]})})})})}),e.jsx(Ce,{deviceType:u,isSpeaking:g,setIsSpeaking:q,currentQuestion:I,setCurrentQuestion:p,currentSection:j,setCurrentSection:N,setIsEndTest:U,module:x,userAllResponse:w,setUserAllResponse:E,handleConfirmEndTest:k,testStarted:F,setIsTestStarted:J,setMicAccessError:Y}),e.jsxs(B,{show:v,onHide:C,centered:!0,className:"p-0",children:[e.jsx(B.Header,{closeButton:!0,children:e.jsx(B.Title,{children:"Test Info"})}),e.jsx(B.Body,{className:"p-0",children:e.jsx(Ne,{module:x,attempt_slug:i})}),e.jsx("div",{className:"modal-footer py-2",children:e.jsx("button",{type:"button",className:"btn btn-outline-primary",onClick:C,children:"Close"})})]}),e.jsxs(B,{show:D,onHide:M,centered:!0,children:[e.jsx(B.Header,{closeButton:!0,children:e.jsx(B.Title,{children:"End Test"})}),e.jsx(B.Body,{children:"Are you sure you want to end the test?"}),e.jsxs(B.Footer,{className:"p-2",children:[e.jsx($,{variant:"outline-primary",onClick:M,children:"No"}),e.jsx($,{variant:"primary",onClick:k,children:"Yes, end test"})]})]})]}):null};export{Le as default};
//# sourceMappingURL=AttemptSpeakingModulePage-e19aea36.js.map
